easyblock = 'PythonBundle'

name = 'chrombpnet'
version = '0.1.7'

homepage = 'https://github.com/kundajelab/chrombpnet'
description = """ ChromBPNet is a fully convolutional neural network that uses dilated convolutions with residual connections to enable large receptive fields with efficient parameterization. It also performs automatic assay bias correction. """

toolchain = {'name': 'foss', 'version': '2021b'}

dependencies = [
    ('SAMtools', '1.15.1'),
    ('BEDTools', '2.30.0'),
    ('Kent_tools', '422'),
    ('pyBigWig', '0.3.18'),
    ('MEME', '5.4.1'),
    ('Python', '3.9.6'),
    ('h5py', '3.6.0'),
    ('pyfaidx', '0.7.0'),
    ('deepdish', '0.3.7'),
    ('matplotlib', '3.4.3'),
    ('modisco', '0.5.16.0'),
    ('modisco-lite', '2.0.7'),
    ('scikit-learn', '1.0.2'),
    ('TensorFlow', '2.8.4'),
    ('tensorflow-probability', '0.16.0'),
    ('protobuf-python', '3.17.3'),
    ('tqdm', '4.62.3'),
    ('kundajelab-shap', '1'),
    ('SciPy-bundle', '2021.10'), # for numpy=1.21.3, pandas=1.3.4  and scipy=1.7.1
    ('WeasyPrint', '52.5'),
]

use_pip = True

# Loosen unnecessarily strict version dependencies
local_preinstallopts = "sed -i 's|pyfaidx==|pyfaidx>=|g' requirements.txt && "
local_preinstallopts += "sed -i 's|scikit-learn>=1.1.2|scikit-learn>=1.0.0|g' requirements.txt && "
local_preinstallopts += "sed -i 's|tensorflow==|tensorflow>=|g' requirements.txt && "
local_preinstallopts += "sed -i 's|tensorflow-probability==|tensorflow-probability>=|g' requirements.txt && "
local_preinstallopts += "sed -i 's|protobuf==3.20|protobuf>=3.17.0|g' requirements.txt && "
local_preinstallopts += "sed -i 's|tqdm==|tqdm>=|g' requirements.txt && "
local_preinstallopts += "sed -i 's|numpy== 1.23.4|numpy>=1.21.0|g' requirements.txt && "

exts_list = [
    ( 'matplotlib-venn', '0.11.6', {
        'checksums': ['d209a9845bb3a54c4247f1ef3f745e4819660ecc9208137097d2a51281f2a478'],
    }),
    ('tensorflow-estimator', '2.8.0', {
        'source_tmpl': 'tensorflow_estimator-%(version)s-py2.py3-none-any.whl',
        'checksums': ['bee8e0520c60ae7eaf6ca8cb46c5a9f4b45725531380db8fbe38fcb48478b6bb'],
    }),
    ( 'deeplift', '0.6.13.0', {
        'checksums': ['354ac5a00630b2df0856e8c948262e38c7eb83a719f71d6b5bf8ec4b064cb432'],
    }),
    (name, version, {
        'preinstallopts': local_preinstallopts,
        'checksums': ['e5fae544d8e533d770c72313b9902097ffd32ef66d5962e90546c3cd9ecce759'],
    }),
]

sanity_check_paths = {
    'files': ['bin/chrombpnet'],
    'dirs': ['lib/python%(pyshortver)s/site-packages'],
}

sanity_check_commands = ["chrombpnet --help"]

sanity_pip_check = True

moduleclass = 'bio'
